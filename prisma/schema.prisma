// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  name          String
  role          Role      @default(agent)
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  websites      Website[]
  assigned_chats Chat[]   @relation("AssignedChats")
  activity_logs ActivityLog[]

  @@index([role], map: "idx_users_role")
  @@index([is_active], map: "idx_users_active")
  @@map("users")
}

enum Role {
  super_admin
  admin
  agent
}

model Website {
  id          String    @id @default(uuid())
  user_id     String
  name        String
  domain      String
  api_key     String    @unique
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  visitors    Visitor[]
  chats       Chat[]
  settings    WidgetSettings?
  ratings     ChatRating[]

  @@index([user_id], map: "idx_websites_user")
  @@map("websites")
}

model Visitor {
  id          String    @id @default(uuid())
  website_id  String
  session_id  String    @unique
  ip_address  String?
  user_agent  String?   @db.Text
  country     String?   @db.VarChar(2)
  last_seen   DateTime  @default(now())
  created_at  DateTime  @default(now())

  website     Website   @relation(fields: [website_id], references: [id], onDelete: Cascade)
  chats       Chat[]
  ratings     ChatRating[]

  @@index([website_id, last_seen], map: "idx_visitors_website_last_seen")
  @@map("visitors")
}

model Chat {
  id          String    @id @default(uuid())
  website_id  String
  visitor_id  String
  assigned_to String?
  status      ChatStatus @default(waiting)
  resolution  String?   @db.Text
  started_at  DateTime  @default(now())
  ended_at    DateTime?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  website     Website   @relation(fields: [website_id], references: [id], onDelete: Cascade)
  visitor     Visitor   @relation(fields: [visitor_id], references: [id], onDelete: Cascade)
  assignee    User?     @relation("AssignedChats", fields: [assigned_to], references: [id])
  messages    Message[]
  ratings     ChatRating[]

  @@index([website_id, updated_at], map: "idx_chats_website_updated")
  @@index([visitor_id, status], map: "idx_chats_visitor_status")
  @@map("chats")
}

enum ChatStatus {
  waiting
  ongoing
  closed
  resolved
}

model Message {
  id          String    @id @default(uuid())
  chat_id     String
  sender_type SenderType
  sender_id   String?
  content     String    @db.Text
  type        MessageType @default(text)
  metadata    Json?
  created_at  DateTime  @default(now())

  chat        Chat      @relation(fields: [chat_id], references: [id], onDelete: Cascade)

  @@index([chat_id, created_at], map: "idx_messages_chat_created")
  @@map("messages")
}

enum SenderType {
  admin
  visitor
  system
}

enum MessageType {
  text
  file
  image
}

model ChatRating {
  id          String   @id @default(uuid())
  chat_id     String   @unique
  website_id  String
  visitor_id  String?
  stars       Int
  comment     String?  @db.Text
  created_at  DateTime @default(now())

  chat        Chat     @relation(fields: [chat_id], references: [id], onDelete: Cascade)
  website     Website  @relation(fields: [website_id], references: [id], onDelete: Cascade)
  visitor     Visitor? @relation(fields: [visitor_id], references: [id])

  @@index([website_id], map: "idx_ratings_website")
  @@index([visitor_id], map: "idx_ratings_visitor")
  @@map("chat_ratings")
}

model WidgetSettings {
  id              String    @id @default(uuid())
  website_id      String    @unique
  primary_color   String?   @default("#2563eb")
  position        WidgetPosition @default(bottom_right)
  welcome_message String?   @default("Hello! How can we help you today?")
  business_hours  Json?
  offline_message String?   @default("We are currently offline. Leave a message and we will get back to you.")
  custom_css      String?   @db.Text
  widget_size     WidgetSize @default(normal)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  website         Website   @relation(fields: [website_id], references: [id], onDelete: Cascade)

  @@map("widget_settings")
}

enum WidgetPosition {
  bottom_right @map("bottom-right")
  bottom_left  @map("bottom-left")
}

enum WidgetSize {
  compact
  normal
}

model ActivityLog {
  id            String    @id @default(uuid())
  user_id       String
  action        String
  resource_type String
  resource_id   String?
  metadata      Json?
  ip_address    String?
  created_at    DateTime  @default(now())

  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at], map: "idx_activity_user_created")
  @@map("activity_logs")
}
